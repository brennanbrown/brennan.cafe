# ============================================================================
# BRENNAN.CAFE HOMELAB DOCKER COMPOSE
# ============================================================================
# Author: Brennan Kenneth Brown
# Description: Main services for brennan.cafe homelab on ThinkPad W520
# Location: ~/brennan.cafe/docker/docker-compose.yml
# ============================================================================

version: '3.9'

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  cafe_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.1.0/24

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  nextcloud_data:
    driver: local
  nextcloud_db:
    driver: local
  jellyfin_config:
    driver: local
  jellyfin_cache:
    driver: local
  hedgedoc_db:
    driver: local
  uptime_kuma:
    driver: local
  plausible_db:
    driver: local
  plausible_events:
    driver: local

# ============================================================================
# SERVICES
# ============================================================================

services:

  # ==========================================================================
  # CADDY - Reverse Proxy & Automatic HTTPS
  # ==========================================================================
  # Priority: Critical
  # Handles all incoming traffic and SSL certificates
  
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/site:/srv:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - cafe_network
    environment:
      - ACME_EMAIL=mail@brennanbrown.ca
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # NEXTCLOUD - File Storage & Sync
  # ==========================================================================
  # Priority: High
  # Self-hosted cloud storage at files.brennan.cafe
  
  nextcloud_db:
    image: postgres:15-alpine
    container_name: nextcloud_db
    restart: unless-stopped
    volumes:
      - nextcloud_db:/var/lib/postgresql/data
    networks:
      - cafe_network
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  nextcloud:
    image: nextcloud:stable-apache
    container_name: nextcloud
    restart: unless-stopped
    depends_on:
      - nextcloud_db
    volumes:
      - nextcloud_data:/var/www/html
      - /media/brennan/external:/external_storage:ro  # Optional: external drive
    networks:
      - cafe_network
    environment:
      - POSTGRES_HOST=nextcloud_db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=brennan
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=files.brennan.cafe
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=files.brennan.cafe
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "8080:80"

  nextcloud_web:
    image: nginx:alpine
    container_name: nextcloud_web
    restart: unless-stopped
    depends_on:
      - nextcloud
    volumes:
      - nextcloud_data:/var/www/html:ro
      - ./nextcloud/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - cafe_network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # JELLYFIN - Media Server
  # ==========================================================================
  # Priority: Medium
  # Self-hosted media streaming at media.brennan.cafe
  
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - /media/brennan/media:/media:ro  # Your media library
    networks:
      - cafe_network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Edmonton  # Calgary timezone
    # Hardware acceleration for NVIDIA Quadro 1000M (optional, if needed)
    # devices:
    #   - /dev/dri:/dev/dri
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # HEDGEDOC - Collaborative Markdown Notes
  # ==========================================================================
  # Priority: Medium
  # Collaborative note-taking at notes.brennan.cafe
  
  hedgedoc_db:
    image: postgres:15-alpine
    container_name: hedgedoc_db
    restart: unless-stopped
    volumes:
      - hedgedoc_db:/var/lib/postgresql/data
    networks:
      - cafe_network
    environment:
      - POSTGRES_DB=hedgedoc
      - POSTGRES_USER=hedgedoc
      - POSTGRES_PASSWORD=${HEDGEDOC_DB_PASSWORD}
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  hedgedoc:
    image: quay.io/hedgedoc/hedgedoc:latest
    container_name: hedgedoc
    restart: unless-stopped
    depends_on:
      - hedgedoc_db
    networks:
      - cafe_network
    environment:
      - CMD_DB_URL=postgres://hedgedoc:${HEDGEDOC_DB_PASSWORD}@hedgedoc_db:5432/hedgedoc
      - CMD_DOMAIN=notes.brennan.cafe
      - CMD_PROTOCOL_USESSL=true
      - CMD_URL_ADDPORT=false
      - CMD_ALLOW_ANONYMOUS=false
      - CMD_ALLOW_ANONYMOUS_EDITS=false
      - CMD_ALLOW_EMAIL_REGISTER=false
      - CMD_SESSION_SECRET=${HEDGEDOC_SESSION_SECRET}
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # UPTIME KUMA - Service Monitoring
  # ==========================================================================
  # Priority: Medium
  # Service monitoring at status.brennan.cafe
  
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_kuma:/app/data
    networks:
      - cafe_network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # PLAUSIBLE - Privacy-Friendly Analytics
  # ==========================================================================
  # Priority: Low
  # Analytics at analytics.brennan.cafe (or embedded on main site)
  
  plausible_db:
    image: postgres:15-alpine
    container_name: plausible_db
    restart: unless-stopped
    volumes:
      - plausible_db:/var/lib/postgresql/data
    networks:
      - cafe_network
    environment:
      - POSTGRES_DB=plausible
      - POSTGRES_USER=plausible
      - POSTGRES_PASSWORD=${PLAUSIBLE_DB_PASSWORD}
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  plausible_events:
    image: clickhouse/clickhouse-server:latest
    container_name: plausible_events
    restart: unless-stopped
    volumes:
      - plausible_events:/var/lib/clickhouse
    networks:
      - cafe_network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  plausible:
    image: plausible/analytics:latest
    container_name: plausible
    restart: unless-stopped
    depends_on:
      - plausible_db
      - plausible_events
    networks:
      - cafe_network
    command: sh -c "sleep 10 && /entrypoint.sh db createdb && /entrypoint.sh db migrate && /entrypoint.sh run"
    environment:
      - BASE_URL=https://analytics.brennan.cafe
      - SECRET_KEY_BASE=${PLAUSIBLE_SECRET_KEY}
      - DATABASE_URL=postgres://plausible:${PLAUSIBLE_DB_PASSWORD}@plausible_db:5432/plausible
      - CLICKHOUSE_DATABASE_URL=http://plausible_events:8123/plausible
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # WATCHTOWER - Automatic Container Updates
  # ==========================================================================
  # Priority: Low
  # Keeps all containers up to date automatically
  
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - cafe_network
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400  # Check daily
      - WATCHTOWER_LABEL_ENABLE=true
      - TZ=America/Edmonton

# ============================================================================
# NOTES
# ============================================================================

# Environment Variables (.env file required):
# - NEXTCLOUD_DB_PASSWORD
# - NEXTCLOUD_ADMIN_PASSWORD
# - HEDGEDOC_DB_PASSWORD
# - HEDGEDOC_SESSION_SECRET
# - PLAUSIBLE_DB_PASSWORD
# - PLAUSIBLE_SECRET_KEY
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose down               # Stop all services
#   docker compose logs -f [service]  # View logs
#   docker compose restart [service]  # Restart specific service
#
# Services can be disabled by commenting them out.
# Each service has its own subdirectory in ~/brennan.cafe/docker/
#
# This configuration prioritizes:
# - Minimal resource usage (Alpine images where possible)
# - Privacy (no external analytics or tracking)
# - Accessibility (all services behind Caddy with HTTPS)
# - Modularity (each service can be independently managed)
# - Ethics (FOSS only, no proprietary software)
#
# Built with love on Treaty 7 territory ðŸŒ»