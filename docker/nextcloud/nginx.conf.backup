# Nginx configuration for Nextcloud in Docker
# Optimized for brennan.cafe homelab
# Used by nextcloud_web container

# ============================================================================
# UPSTREAM CONFIGURATION
# ============================================================================

upstream php-handler {
    server nextcloud:9000;
}

# ============================================================================
# MAIN SERVER CONFIGURATION
# ============================================================================

server {
    listen 80;
    server_name files.brennan.cafe;
    
    # ============================================================================
    # SECURITY HEADERS
    # ============================================================================
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Other security headers
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Robots-Tag "none" always;
    add_header X-Download-Options "noopen" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    
    # Remove server signature
    server_tokens off;
    
    # ============================================================================
    # PATHS AND DIRECTORIES
    # ============================================================================
    
    # Max upload size
    client_max_body_size 10G;
    client_body_timeout 300s;
    client_header_timeout 300s;
    
    # Root directory
    root /var/www/html;
    
    # ============================================================================
    # INDEX CONFIGURATION
    # ============================================================================
    
    index index.php index.html /index.php$request_uri;
    
    # ============================================================================
    # LOCATION BLOCKS
    # ============================================================================
    
    # Main Nextcloud app
    location / {
        try_files $uri $uri/ /index.php$request_uri;
    }
    
    # PHP processing
    location ~ \.php(?:$|/) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        set $path_info $fastcgi_path_info;
        
        try_files $fastcgi_script_name =404;
        
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param HTTPS on;
        fastcgi_param modHeadersAvailable true;
        
        # Increase timeouts for large files
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_connect_timeout 300s;
        
        fastcgi_pass php-handler;
        
        # Nextcloud specific headers
        fastcgi_param HTTP_PROXY "";  # Mitigate httpoxy vulnerability
    }
    
    # Static assets with caching
    location ~* \.(?:css|js|svg|gif|png|jpg|jpeg|ico|wasm|tflite|map)$ {
        try_files $uri /index.php$request_uri;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
    }
    
    # WebDAV
    location ~* /remote.php  {
        try_files $uri /index.php$request_uri;
    }
    
    # ============================================================================
    # SECURITY - HIDDEN FILES
    # ============================================================================
    
    location ~ ^/(?:\.autotest|\.build|\.env|config|db|storage|tests|vendor)/ {
        deny all;
    }
    
    location ~ ^/(?:\.htaccess|\.git|\.svn) {
        deny all;
    }
    
    # ============================================================================
    # PERFORMANCE - GZIP
    # ============================================================================
    
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 512;
    gzip_proxied any;
    gzip_disable "msie6";
    gzip_types
        application/atom+xml
        application/geo+json
        application/javascript
        application/x-javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rdf+xml
        application/rss+xml
        application/xhtml+xml
        application/xml
        font/eot
        font/otf
        font/ttf
        image/svg+xml
        text/css
        text/javascript
        text/plain
        text/xml;
    
    # ============================================================================
    # LOGGING
    # ============================================================================
    
    access_log /var/log/nginx/files.brennan.cafe.access.log;
    error_log /var/log/nginx/files.brennan.cafe.error.log warn;
    
    # ============================================================================
    # NEXTCLOUD SPECIFIC OPTIMIZATIONS
    # ============================================================================
    
    # Avoid processing if the request is for a static file
    location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|ocs-provider/.+)\.php(?:$|/) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        set $path_info $fastcgi_path_info;
        
        try_files $fastcgi_script_name =404;
        
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param HTTPS on;
        fastcgi_param modHeadersAvailable true;
        
        fastcgi_pass php-handler;
        fastcgi_intercept_errors on;
        fastcgi_request_buffering off;
    }
    
    # Favicon - no error log
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
    
    # Robots.txt - no error log
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }
    
    # ============================================================================
    # MAINTENANCE MODE
    # ============================================================================
    
    # Uncomment these lines for maintenance mode
    # if (-f $document_root/.maintenance) {
    #     return 503;
    # }
    
    # error_page 503 @maintenance;
    # location @maintenance {
    #     rewrite ^(.*)$ /index.php?s=$1&maintenance=1 last;
    # }
}

# ============================================================================
# NOTES
# ============================================================================

# This configuration:
# - Handles Nextcloud's PHP application
# - Implements security best practices
# - Optimizes for file uploads and downloads
# - Includes proper caching for static assets
# - Supports WebDAV for file sync
# - Is optimized for Docker environment
#
# Used by:
# - nextcloud_web container in docker-compose.yml
# - Serves files.brennan.cafe through Caddy reverse proxy
#
# Performance considerations:
# - 10G upload limit for large files
# - Extended timeouts for file operations
# - Gzip compression for text-based assets
# - Long-term caching for static files
#
# Security considerations:
# - HSTS enforcement
# - Hidden file protection
# - HTTPoxy vulnerability mitigation
# - Server signature removal
